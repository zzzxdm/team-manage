{% extends "base.html" %}

{% block title %}控制台 - GPT Team 管理系统{% endblock %}

{% block content %}
<div class="page-header">
    <h2>控制台</h2>
</div>

<!-- 统计卡片 -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon"><i data-lucide="users"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.total_teams }}</div>
            <div class="stat-label">Team 总数</div>
        </div>
    </div>
    <div class="stat-card stat-success">
        <div class="stat-icon"><i data-lucide="check-circle"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.available_teams }}</div>
            <div class="stat-label">可用 Team</div>
        </div>
    </div>
    <div class="stat-card stat-info">
        <div class="stat-icon"><i data-lucide="ticket"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.total_codes }}</div>
            <div class="stat-label">兑换码总数</div>
        </div>
    </div>
    <div class="stat-card stat-warning">
        <div class="stat-icon"><i data-lucide="clipboard-list"></i></div>
        <div class="stat-info-group">
            <div class="stat-value">{{ stats.used_codes }}</div>
            <div class="stat-label">已使用兑换码</div>
        </div>
    </div>
</div>

<!-- Team 列表 -->
<div class="content-section">
    <div class="section-header">
        <h3>Team 列表</h3>
        <div class="header-group">
            <form action="/admin" method="get" class="search-form">
                <div class="input-group-clean">
                    <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                    <input type="text" name="search" value="{{ search or '' }}" placeholder="搜索邮箱/Account ID..."
                        style="width: 200px;">
                    {% if search %}
                    <a href="/admin" title="清除搜索">
                        <i data-lucide="x-circle" style="width: 14px; height: 14px;"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
            <button onclick="showModal('importTeamModal')" class="btn btn-primary">
                <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i> 导入 Team
            </button>
        </div>
    </div>

    {% if teams %}
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>邮箱</th>
                    <th>Account ID</th>
                    <th>Team 名称</th>
                    <th>成员数</th>
                    <th>订阅计划</th>
                    <th>到期时间</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for team in teams %}
                <tr>
                    <td><span class="text-muted">{{ team.id }}</span></td>
                    <td>{{ team.email }}</td>
                    <td><span class="text-muted small">{{ team.account_id or '-' }}</span></td>
                    <td>{{ team.team_name or '-' }}</td>
                    <td>
                        <span class="member-count">
                            {{ team.current_members }}/{{ team.max_members }}
                        </span>
                    </td>
                    <td>{{ team.subscription_plan or '-' }}</td>
                    <td>
                        {% if team.expires_at %}
                        {{ team.expires_at|format_datetime }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ team.status }}">
                            {% if team.status == 'active' %}
                            可用
                            {% elif team.status == 'full' %}
                            已满
                            {% elif team.status == 'expired' %}
                            已过期
                            {% else %}
                            异常
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-info btn-view-members" data-id="{{ team.id }}"
                                data-email="{{ team.email }}" title="查看成员">
                                <i data-lucide="users"></i> 成员
                            </button>
                            <button class="btn btn-sm btn-secondary btn-refresh-team" data-id="{{ team.id }}"
                                title="刷新">
                                <i data-lucide="refresh-cw"></i> 刷新
                            </button>
                            <button class="btn btn-sm btn-danger btn-delete-team" data-id="{{ team.id }}"
                                data-email="{{ team.email }}" title="删除">
                                <i data-lucide="trash-2"></i> 删除
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页 -->
    {% if pagination and pagination.total_pages > 1 %}
    <div class="pagination">
        {% set search_param = '&search=' + search if search else '' %}

        {% if pagination.current_page > 1 %}
        <a href="?page=1{{ search_param }}" class="btn btn-sm btn-secondary">首页</a>
        <a href="?page={{ pagination.current_page - 1 }}{{ search_param }}" class="btn btn-sm btn-secondary">
            <i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i>
        </a>
        {% endif %}

        <span class="pagination-info">第 {{ pagination.current_page }} / {{ pagination.total_pages }} 页</span>

        {% if pagination.current_page < pagination.total_pages %} <a
            href="?page={{ pagination.current_page + 1 }}{{ search_param }}" class="btn btn-sm btn-secondary">
            <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
            </a>
            <a href="?page={{ pagination.total_pages }}{{ search_param }}" class="btn btn-sm btn-secondary">末页</a>
            {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <p>暂无 Team 数据</p>
        <button onclick="showModal('importTeamModal')" class="btn btn-primary">立即导入</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 绑定查看成员按钮
        document.querySelectorAll('.btn-view-members').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const email = btn.getAttribute('data-email');
                viewMembers(id, email);
            });
        });

        // 绑定刷新按钮
        document.querySelectorAll('.btn-refresh-team').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                refreshTeam(id);
            });
        });

        // 绑定删除按钮
        document.querySelectorAll('.btn-delete-team').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const email = btn.getAttribute('data-email');
                deleteTeam(id, email);
            });
        });
    });

    async function refreshTeam(teamId) {
        if (!confirm('确定要刷新此 Team 的信息吗?')) {
            return;
        }

        try {
            showToast('正在刷新...', 'info');
            const response = await fetch(`/api/teams/${teamId}/refresh`, {
                method: 'GET'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('刷新成功', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || '刷新失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }

    async function deleteTeam(teamId, email) {
        if (!confirm(`确定要删除 Team "${email}" 吗?\n\n此操作不可恢复!`)) {
            return;
        }

        try {
            showToast('正在删除...', 'info');
            const response = await fetch(`/admin/teams/${teamId}/delete`, {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast('删除成功', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || '删除失败', 'error');
            }
        } catch (error) {
            showToast('网络错误', 'error');
        }
    }
</script>
{% endblock %}